<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tap & Earn</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h1, h2 { margin-bottom: 10px; }
    .section { margin-top: 20px; padding: 15px; background: #111; border-radius: 10px; }
    .btn {
      display: inline-block;
      margin-top: 10px;
      padding: 10px 15px;
      border-radius: 8px;
      background: #ffc107;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
    }
    .btn:active { transform: scale(0.95); }
    .hidden { display: none; }
    input, select {
      padding: 8px; margin: 5px 0; width: 100%; border-radius: 5px; border: none;
    }
  </style>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- AdsGram SDK -->
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <!-- Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9852168' data-sdk='show_9852168'></script>
</head>

<body>
  <h1>‚ö° Tap & Earn point</h1>

  <p>Points: <span id="points">0</span> | Energy: <span id="energy">50</span></p>
  <div class="btn" id="tapBtn">‚ö° Tap for 30sec an claim 1000 point</div>

  <!-- Tasks Section -->
  <div class="section">
    <h2>üìã Tasks</h2>
    <div id="taskIntro">
      <div class="btn" id="startTasksBtn">Start Tasks</div>
    </div>
    <div id="adsgram-container" class="hidden"></div>
    <div id="nextTaskBtnContainer" class="hidden">
      <div class="btn" id="nextTaskBtn">‚û°Ô∏è Next Task</div>
    </div>
    <div id="finalTaskBtnContainer" class="hidden">
      <div class="btn" id="finalTaskBtn">üèÅ Finish Tasks</div>
    </div>
  </div>

  <!-- Withdrawal -->
  <div class="section">
    <h2>üí≥ Withdraw</h2>
    <label>Method:</label>
    <select id="method">
      <option value="Litecoin">Litecoin</option>
      <option value="USDT">USDT</option>
      <option value="Payeer">Payeer</option>
      <option value="Bank">Bank Account</option>
    </select>
    <label>Wallet/Account:</label>
    <input type="text" id="address" placeholder="Enter wallet or account"/>
    <label>Amount:</label>
    <input type="number" id="amount" placeholder="Min 5000"/>
    <div class="btn" id="withdrawBtn">Request Withdraw</div>
  </div>

  <!-- Referral -->
  <div class="section">
    <h2>üë• Referral Program</h2>
    <p>Your referral link:</p>
    <input type="text" id="refLink" readonly/>
    <div class="btn" id="copyRefBtn">Copy Link</div>
  </div>

<script>
const webApp = Telegram.WebApp;

// RESTORE (NEVER wipe)
let points = parseInt(localStorage.getItem("points") || "0");
let energy = parseInt(localStorage.getItem("energy") || "50");

// EXTRA RESTORE (fix browser delay)
points = parseInt(localStorage.getItem("points") || points);
energy = parseInt(localStorage.getItem("energy") || energy);

// UI update
function updateUI() {
  document.getElementById("points").innerText = points;
  document.getElementById("energy").innerText = energy;
}

// Save to storage
function saveState() {
  localStorage.setItem("points", points);
  localStorage.setItem("energy", energy);
}

// NEW: auto save even if user closes app
window.addEventListener("beforeunload", () => {
  saveState();
});

// Tap logic unchanged
document.getElementById("tapBtn").addEventListener("click", () => {
  if (energy > 0) {
    points += 5;
    energy -= 5;
    saveState(); updateUI();
  } else {
    if (typeof window.show_9852168 === "function") {
      show_9852168().then(() => {
        energy += 20;
        saveState(); updateUI();
      });
    }
  }
});

// Withdraw
document.getElementById("withdrawBtn").addEventListener("click", () => {
  const method = document.getElementById("method").value;
  const address = document.getElementById("address").value.trim();
  const amount = parseInt(document.getElementById("amount").value);
  if (isNaN(amount) || amount < 5000) { alert("Minimum withdrawal is 5000 points"); return; }
  if (points < amount) { alert("Not enough points"); return; }

  const user = webApp.initDataUnsafe.user || {};
  const msg = JSON.stringify({
    type: "withdraw_request",
    user_id: user.id,
    username: user.username || "No username",
    amount, method, address
  });

  Telegram.WebApp.sendData(msg);

  points -= amount; saveState(); updateUI();
  alert("‚úÖ Withdrawal request sent! Admin will process it soon.");
});

// Referral
const user = webApp.initDataUnsafe.user || {};
const userId = user.id || "guest";
document.getElementById("refLink").value = `https://t.me/Tapancebot?start=${userId}`;
document.getElementById("copyRefBtn").addEventListener("click", () => {
  const refInput = document.getElementById("refLink");
  refInput.select(); document.execCommand("copy");
});

// Tasks (unchanged)
let currentTaskIndex = 0;
const taskIds = ["task-17591", "task-17592", "task-17593", "task-17595", "task-17594", "task-17593"];

function loadTask(blockId) {
  const taskContainer = document.getElementById("adsgram-container");
  taskContainer.innerHTML = `<adsgram-task class="task" data-block-id="${blockId}"></adsgram-task>`;
  taskContainer.classList.remove("hidden");
  document.getElementById("taskIntro").classList.add("hidden");

  const task = taskContainer.querySelector(".task");
  task.addEventListener("reward", (e) => {
    const reward = e.detail?.reward || 10;
    points += reward;
    energy += 20;
    saveState();
    updateUI();

    if (currentTaskIndex < taskIds.length - 1) {
      document.getElementById("nextTaskBtnContainer").classList.remove("hidden");
    } else {
      document.getElementById("finalTaskBtnContainer").classList.remove("hidden");
    }
  });
}

document.getElementById("startTasksBtn").addEventListener("click", () => {
  currentTaskIndex = 0;
  loadTask(taskIds[currentTaskIndex]);
});

document.getElementById("nextTaskBtn").addEventListener("click", () => {
  currentTaskIndex++;
  document.getElementById("nextTaskBtnContainer").classList.add("hidden");
  loadTask(taskIds[currentTaskIndex]);
});

document.getElementById("finalTaskBtn").addEventListener("click", () => {
  if (typeof window.show_9852168 === "function") {
    show_9852168().then(() => {
      document.getElementById("taskIntro").classList.remove("hidden");
      document.getElementById("adsgram-container").classList.add("hidden");
      document.getElementById("finalTaskBtnContainer").classList.add("hidden");
      currentTaskIndex = 0;
      updateUI();
    });
  }
});

// Page load
document.addEventListener("DOMContentLoaded", () => {
  updateUI();
});
</script>
</body>
</html>
